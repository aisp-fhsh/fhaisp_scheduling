<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 元素選擇器 (和你原本的一樣) ---
        const staffNameInput = document.getElementById('staffNameInput');
        const staffCategorySelect = document.getElementById('staffCategorySelect');
        const addStaffBtn = document.getElementById('addStaffBtn');
        const staffListContainer = document.getElementById('staffList');
        const availabilityGridContainer = document.getElementById('availabilityGrid');
        const generateBtn = document.getElementById('generateBtn');
        const scheduleResultContainer = document.getElementById('scheduleResult');
        const scheduleDisplay = document.getElementById('scheduleDisplay');
        const errorMessage = document.getElementById('errorMessage');

        const days = ['星期一', '星期二', '星期三', '星期四', '星期五'];
        
        let staffMembers = []; // 儲存人員物件 { name: '名字', category: 'member'/'cadre' }
        let availability = {}; // 儲存每個人的空閒狀態

        // --- 資料處理函式 ---
        function loadData() {
            const storedStaff = localStorage.getItem('staffMembers');
            const storedAvailability = localStorage.getItem('availability');
            if (storedStaff) {
                staffMembers = JSON.parse(storedStaff);
            }
            if (storedAvailability) {
                availability = JSON.parse(storedAvailability);
            }
            renderStaffList();
            renderAvailabilityGrid();
        }

        function saveData() {
            localStorage.setItem('staffMembers', JSON.stringify(staffMembers));
            localStorage.setItem('availability', JSON.stringify(availability));
        }

        // --- 渲染畫面函式 ---
        function renderStaffList() {
            staffListContainer.innerHTML = '';
            if (staffMembers.length === 0) {
                staffListContainer.innerHTML = '<p class="text-center text-gray-400">目前沒有人員。</p>';
                return;
            }
            staffMembers.forEach(person => {
                const categoryText = person.category === 'cadre' ? '幹部' : '成員';
                const personItem = document.createElement('div');
                personItem.className = 'person-item';
                personItem.innerHTML = `
                    <span>${person.name} (${categoryText})</span>
                    <button class="btn-red p-2 rounded-full w-8 h-8 flex items-center justify-center text-sm" data-name="${person.name}">
                        &times;
                    </button>
                `;
                staffListContainer.appendChild(personItem);
            });
        }

        function renderAvailabilityGrid() {
            availabilityGridContainer.innerHTML = '';
            staffMembers.forEach(person => {
                if (!availability[person.name]) {
                    availability[person.name] = new Array(5).fill(true); // 預設全部有空
                }
                
                // 姓名欄位
                const nameCell = document.createElement('div');
                nameCell.className = 'grid-cell font-bold';
                nameCell.textContent = person.name;
                availabilityGridContainer.appendChild(nameCell);

                // 星期一到五的狀態欄位
                for (let i = 0; i < 5; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = `grid-cell schedule-cell ${availability[person.name][i] ? 'available' : 'unavailable'}`;
                    dayCell.dataset.day = i;
                    dayCell.dataset.person = person.name;
                    // 這裡不顯示文字，只用顏色區分
                    dayCell.addEventListener('click', () => {
                        // --- 這裡是你的程式碼被切斷的地方，現在已補全 ---
                        availability[person.name][i] = !availability[person.name][i];
                        renderAvailabilityGrid(); // 重新渲染以更新顏色
                        saveData(); // 儲存變更
                    });
                    availabilityGridContainer.appendChild(dayCell);
                }
            });
        }
        
        // --- 核心功能：新增、刪除、產生排班表 ---

        // 1. 新增人員
        function addStaff() {
            const name = staffNameInput.value.trim();
            const category = staffCategorySelect.value;
            if (name && !staffMembers.some(p => p.name === name)) {
                staffMembers.push({ name, category });
                staffNameInput.value = '';
                renderStaffList();
                renderAvailabilityGrid();
                saveData();
            } else if (name) {
                alert('此姓名已存在！');
            }
        }

        // 2. 刪除人員 (使用事件委派)
        function removeStaff(e) {
            if (e.target && e.target.tagName === 'BUTTON' && e.target.dataset.name) {
                const nameToRemove = e.target.dataset.name;
                staffMembers = staffMembers.filter(p => p.name !== nameToRemove);
                delete availability[nameToRemove]; // 同時刪除空閒資料
                renderStaffList();
                renderAvailabilityGrid();
                saveData();
            }
        }

        // 3. 產生排班表
        function generateSchedule() {
            scheduleResultContainer.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            scheduleDisplay.innerHTML = '';

            const cadres = staffMembers.filter(p => p.category === 'cadre');
            const members = staffMembers.filter(p => p.category === 'member');
            
            let schedule = {};

            for (let i = 0; i < 5; i++) {
                const day = days[i];
                schedule[day] = [];

                // 找出當天有空的幹部和成員
                const availableCadres = cadres.filter(p => availability[p.name][i]);
                const availableMembers = members.filter(p => availability[p.name][i]);

                // 簡單排班邏輯：每天盡量選1個幹部 + 1個成員
                // 為了避免重複，我們打亂順序
                const shuffledCadres = availableCadres.sort(() => 0.5 - Math.random());
                const shuffledMembers = availableMembers.sort(() => 0.5 - Math.random());

                if (shuffledCadres.length > 0) {
                    schedule[day].push(shuffledCadres[0].name);
                }
                if (shuffledMembers.length > 0) {
                    schedule[day].push(shuffledMembers[0].name);
                }

                if (schedule[day].length < 2) {
                     errorMessage.textContent = `${day}人力不足，無法排出理想班表！`;
                     errorMessage.classList.remove('hidden');
                }
            }

            // 將結果顯示在畫面上
            for (const day in schedule) {
                const dayElement = document.createElement('div');
                dayElement.className = "p-4 bg-gray-800 rounded-lg";
                const staffText = schedule[day].length > 0 ? schedule[day].join('、') : '本日無人';
                dayElement.innerHTML = `<h3 class="font-bold text-lg">${day}</h3><p>${staffText}</p>`;
                scheduleDisplay.appendChild(dayElement);
            }
        }
        
        // --- 綁定所有事件監聽器 ---
        addStaffBtn.addEventListener('click', addStaff);
        staffListContainer.addEventListener('click', removeStaff);
        generateBtn.addEventListener('click', generateSchedule);

        // --- 初始載入 ---
        loadData();
    });
</script>

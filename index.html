<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端同步排班系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center; /* 改為 center */
            min-height: 100vh;
            padding: 40px 20px;
        }
        .glass-container {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2.5rem;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .input-group { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
        .schedule-grid { display: grid; grid-template-columns: 120px repeat(5, 1fr); gap: 0.5rem; width: 100%; }
        .availability-wrapper { overflow-x: auto; padding-bottom: 1rem; }
        .grid-header, .grid-cell { padding: 0.75rem; text-align: center; border-radius: 0.5rem; background-color: rgba(255, 255, 255, 0.05); font-size: 0.875rem; }
        .grid-header { font-weight: bold; background-color: rgba(255, 255, 255, 0.1); }
        .schedule-cell { min-height: 40px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .schedule-cell.available { background-color: rgba(74, 222, 128, 0.4); }
        .schedule-cell.available:hover { background-color: rgba(74, 222, 128, 0.6); }
        .schedule-cell.unavailable { background-color: rgba(248, 113, 113, 0.3); }
        .schedule-cell.unavailable:hover { background-color: rgba(248, 113, 113, 0.5); }
        .person-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(255, 255, 255, 0.05); padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .btn { background-color: rgba(74, 144, 226, 0.5); color: white; padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: bold; transition: all 0.3s; border: none; cursor: pointer; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
        .btn:disabled { background-color: rgba(107, 114, 128, 0.3); color: rgba(255,255,255,0.5); cursor: not-allowed; }
        .btn-red { background-color: rgba(255, 99, 71, 0.6); }
        .btn-red:hover:not(:disabled) { background-color: rgba(255, 99, 71, 0.8); }
        .history-item { background-color: rgba(255, 255, 255, 0.05); border-left: 4px solid rgba(74, 144, 226, 0.5); padding: 1rem; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Firebase 設定提示畫面 -->
    <div id="config-warning" class="hidden glass-container text-center">
        <h1 class="text-3xl font-bold text-red-400 mb-4">設定錯誤：Firebase 尚未設定</h1>
        <p class="mb-2">您尚未在程式碼中設定您的 Firebase 專案金鑰。</p>
        <p>請依照程式碼中的註解，打開 <code>index.html</code> 檔案，找到 <code>firebaseConfig</code> 物件，並用您自己的 Firebase 專案設定取代預設值。</p>
    </div>

    <!-- 主應用程式容器 -->
    <div id="main-app-container" class="hidden glass-container">
        <!-- 主應用程式畫面 -->
        <div id="app-container">
             <!-- 主排班系統畫面 -->
            <div id="main-view">
                <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
                    <h1 class="text-4xl font-bold text-center">排班系統</h1>
                    <button id="viewHistoryBtn" class="btn text-sm p-2 px-4">查看歷史紀錄</button>
                </div>
                 <div class="space-y-4">
                    <h2 class="text-2xl font-semibold">1. 人員管理</h2>
                    <div class="input-group">
                        <input type="text" id="staffNameInput" class="flex-grow p-3 rounded-lg bg-gray-700 bg-opacity-50 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="輸入工作人員姓名">
                        <select id="staffCategorySelect" class="p-3 rounded-lg bg-gray-700 bg-opacity-50 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="member">成員</option>
                            <option value="cadre">幹部</option>
                        </select>
                        <button id="addStaffBtn" class="btn">新增人員</button>
                    </div>
                    <div id="staffList" class="space-y-2"></div>
                </div>
                <div class="space-y-4 mt-8">
                    <h2 class="text-2xl font-semibold">2. 設定每日空閒狀態</h2>
                    <p class="text-sm text-gray-400">點擊方格來切換人員當天是否有空。</p>
                    <div id="availabilityContainer" class="availability-wrapper"></div>
                </div>
                <div class="space-y-4 mt-8">
                    <h2 class="text-2xl font-semibold">3. 產生排班表</h2>
                    <div class="flex justify-center">
                        <button id="generateBtn" class="btn btn-red">產生排班表 (並自動儲存)</button>
                    </div>
                </div>
                <div id="scheduleResult" class="space-y-4 hidden mt-8">
                    <h2 class="text-2xl font-semibold">最新排班結果</h2>
                    <div id="scheduleDisplay" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>
                </div>
            </div>

            <!-- 歷史紀錄畫面 -->
            <div id="history-view" class="hidden w-full">
                <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
                    <h1 class="text-4xl font-bold">歷史排班紀錄</h1>
                    <button id="backToMainBtn" class="btn text-sm p-2 px-4">返回排班系統</button>
                </div>
                <div class="flex justify-end mb-4">
                    <button id="clearHistoryBtn" class="btn-red text-sm p-2 px-4">清空所有紀錄</button>
                </div>
                <div id="historyList" class="space-y-3"></div>
            </div>
        </div>

        <!-- 錯誤訊息提示框 -->
        <div id="error-message-box" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg hidden animate-pulse"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ===================================================================================
        // == 重要！請將此處替換為您自己的 Firebase 專案設定 ==
        // == 1. 前往 Firebase 控制台 (console.firebase.google.com)
        // == 2. 進入您的專案，點擊左上角齒輪 -> 專案設定
        // == 3. 在「一般」分頁下方，複製您的 firebaseConfig 物件並貼到此處
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // ===================================================================================

        // --- 元素選擇器 ---
        const configWarning = document.getElementById('config-warning');
        const mainAppContainer = document.getElementById('main-app-container');
        const appContainer = document.getElementById('app-container');
        const mainView = document.getElementById('main-view');
        const historyView = document.getElementById('history-view');
        const viewHistoryBtn = document.getElementById('viewHistoryBtn');
        const backToMainBtn = document.getElementById('backToMainBtn');
        const staffNameInput = document.getElementById('staffNameInput');
        const staffCategorySelect = document.getElementById('staffCategorySelect');
        const addStaffBtn = document.getElementById('addStaffBtn');
        const staffListContainer = document.getElementById('staffList');
        const availabilityContainer = document.getElementById('availabilityContainer');
        const generateBtn = document.getElementById('generateBtn');
        const scheduleResultContainer = document.getElementById('scheduleResult');
        const scheduleDisplay = document.getElementById('scheduleDisplay');
        const historyList = document.getElementById('historyList');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const errorMessageBox = document.getElementById('error-message-box');
        
        // --- 初始化應用程式 ---
        startApp();

        function startApp() {
            // 檢查 firebaseConfig 是否已設定
            if (firebaseConfig.apiKey.startsWith("YOUR_")) {
                mainAppContainer.classList.add('hidden');
                configWarning.classList.remove('hidden');
                return; // 停止執行後續程式碼
            }

            mainAppContainer.classList.remove('hidden');

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // --- 全域變數和常數 ---
            const days = ['星期一', '星期二', '星期三', '星期四', '星期五'];
            const scheduleDocRef = doc(db, "schedules", "mainSchedule");
            let staffMembers = [];
            let availability = {};
            let scheduleHistory = [];
            
            // --- 啟動資料監聽 ---
            listenToScheduleData();

            // --- Firestore 即時資料庫邏輯 ---
            function listenToScheduleData() {
                return onSnapshot(scheduleDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        staffMembers = data.staffMembers || [];
                        availability = data.availability || {};
                        scheduleHistory = data.scheduleHistory || [];
                    } else {
                        // 如果雲端沒有資料，則建立一個空的
                        updateScheduleData();
                    }
                    renderAll();
                });
            }
            
            async function updateScheduleData() {
                const dataToSave = { staffMembers, availability, scheduleHistory };
                try {
                    await setDoc(scheduleDocRef, dataToSave);
                } catch (error) {
                    displayError("資料儲存失敗: " + error.message);
                }
            }
            
            // --- 渲染畫面函式 ---
            function renderAll() {
                renderStaffList();
                renderAvailabilityGrid();
                renderHistoryList();
            }

            function renderStaffList() {
                staffListContainer.innerHTML = '';
                if (staffMembers.length === 0) {
                    staffListContainer.innerHTML = '<p class="text-center text-gray-400">目前沒有人員。</p>';
                } else {
                    staffMembers.forEach(person => {
                        const categoryText = person.category === 'cadre' ? '幹部' : '成員';
                        const personItem = document.createElement('div');
                        personItem.className = 'person-item';
                        personItem.innerHTML = `
                            <span>${person.name} (${categoryText})</span>
                            <button class="btn-red p-2 rounded-full w-8 h-8 flex items-center justify-center text-sm" data-name="${person.name}">&times;</button>
                        `;
                        staffListContainer.appendChild(personItem);
                    });
                }
            }

            function renderAvailabilityGrid() {
                availabilityContainer.innerHTML = '';
                if (staffMembers.length === 0) return;
                const grid = document.createElement('div');
                grid.className = 'schedule-grid';
                let headerHTML = `<div class="grid-header">姓名</div>`;
                days.forEach(day => headerHTML += `<div class="grid-header">${day}</div>`);
                grid.innerHTML = headerHTML;
                staffMembers.forEach(person => {
                    if (!availability[person.name]) {
                        availability[person.name] = Array(days.length).fill(true);
                    }
                    let rowHTML = `<div class="grid-cell font-bold">${person.name}</div>`;
                    for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
                        const isAvailable = availability[person.name][dayIndex];
                        rowHTML += `<div class="schedule-cell ${isAvailable ? 'available' : 'unavailable'}" data-person="${person.name}" data-day="${dayIndex}"></div>`;
                    }
                    grid.innerHTML += rowHTML;
                });
                availabilityContainer.appendChild(grid);
            }

            function renderHistoryList() {
                historyList.innerHTML = '';
                if (scheduleHistory.length === 0) {
                    historyList.innerHTML = '<p class="text-center text-gray-400">沒有歷史紀錄。</p>';
                } else {
                    [...scheduleHistory].reverse().forEach(record => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        const date = new Date(record.timestamp).toLocaleString('zh-TW');
                        let scheduleHTML = '<dl class="space-y-2">';
                        days.forEach((day, dayIndex) => {
                            const people = record.schedule[dayIndex].join('、') || '無人';
                            scheduleHTML += `<div><dt class="font-bold">${day}</dt><dd class="pl-4 text-sm">${people}</dd></div>`;
                        });
                        scheduleHTML += '</dl>';
                        item.innerHTML = `<h3 class="font-bold text-lg">儲存時間: ${date}</h3>${scheduleHTML}`;
                        historyList.appendChild(item);
                    });
                }
            }

            // --- 核心功能函式 ---
            function addStaff() {
                const name = staffNameInput.value.trim();
                const category = staffCategorySelect.value;
                if (name && !staffMembers.some(p => p.name === name)) {
                    staffMembers.push({ name, category });
                    staffNameInput.value = '';
                    updateScheduleData();
                } else if (name) {
                    displayError('此姓名已存在！');
                }
            }

            function removeStaff(e) {
                if (e.target && e.target.dataset.name) {
                    const nameToRemove = e.target.dataset.name;
                    staffMembers = staffMembers.filter(p => p.name !== nameToRemove);
                    delete availability[nameToRemove];
                    updateScheduleData();
                }
            }
            
            function toggleAvailability(e) {
                const { person, day } = e.target.dataset;
                if (person && day) {
                    const dayIndex = parseInt(day);
                    availability[person][dayIndex] = !availability[person][dayIndex];
                    updateScheduleData();
                }
            }

            function generateSchedule() {
                if (staffMembers.length < 3) {
                    displayError('人員太少，無法排班 (至少需要3人)');
                    return;
                }
                const PEOPLE_PER_DAY = 3;
                let schedule = Array(days.length).fill(null).map(() => []);
                let workCounts = Object.fromEntries(staffMembers.map(p => [p.name, 0]));
                let errors = [];

                for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
                    const availableStaff = staffMembers
                        .filter(p => availability[p.name]?.[dayIndex])
                        .sort((a, b) => workCounts[a.name] - workCounts[b.name]);

                    if (availableStaff.length < PEOPLE_PER_DAY) {
                        errors.push(`${days[dayIndex]}`);
                    }
                    const peopleForDay = availableStaff.slice(0, PEOPLE_PER_DAY);
                    schedule[dayIndex] = peopleForDay.map(p => p.name);
                    peopleForDay.forEach(p => workCounts[p.name]++);
                }
                
                displaySchedule(schedule);
                saveToHistory(schedule);

                if (errors.length > 0) {
                    displayError(`注意：${errors.join('、')} 人力不足，無法排滿${PEOPLE_PER_DAY}人。`);
                }
            }

            function displaySchedule(schedule) {
                scheduleResultContainer.classList.remove('hidden');
                scheduleDisplay.innerHTML = '';
                schedule.forEach((daySchedule, dayIndex) => {
                    const dayItem = document.createElement('div');
                    dayItem.className = 'bg-gray-700 bg-opacity-30 rounded-lg p-4 space-y-2';
                    const peopleText = daySchedule.length > 0 ? daySchedule.join('、') : '本日無人';
                    dayItem.innerHTML = `<h3 class="text-xl font-bold">${days[dayIndex]}</h3><p>${peopleText}</p>`;
                    scheduleDisplay.appendChild(dayItem);
                });
            }

            function saveToHistory(schedule) {
                if (schedule) {
                    scheduleHistory.push({ timestamp: Date.now(), schedule });
                    updateScheduleData();
                }
            }
            
            function clearHistory() {
                if (confirm('確定要清空所有歷史紀錄嗎？此操作無法復原。')) {
                    scheduleHistory = [];
                    updateScheduleData();
                }
            }

            // --- 事件監聽器與UI互動 ---
            addStaffBtn.addEventListener('click', addStaff);
            staffListContainer.addEventListener('click', removeStaff);
            availabilityContainer.addEventListener('click', toggleAvailability);
            generateBtn.addEventListener('click', generateSchedule);
            clearHistoryBtn.addEventListener('click', clearHistory);
            viewHistoryBtn.addEventListener('click', showHistoryView);
            backToMainBtn.addEventListener('click', showMainView);
        }

        function displayError(message) {
            errorMessageBox.textContent = message;
            errorMessageBox.classList.remove('hidden');
            setTimeout(() => errorMessageBox.classList.add('hidden'), 3000);
        }
        function showMainView() {
            mainView.classList.remove('hidden');
            historyView.classList.add('hidden');
        }
        function showHistoryView() {
            mainView.classList.add('hidden');
            historyView.classList.remove('hidden');
        }
    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排班系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General styles */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .main-container {
            display: flex;
            gap: 2rem;
            width: 100%;
            max-width: 1200px;
            margin: 1rem auto;
        }
        .left-panel, .right-panel {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 4px 30px rgba(0,0,0,0.1);
            transition: background-color 0.3s, border 0.3s;
        }
        .left-panel { flex: 1; min-width: 320px; }
        .right-panel { flex: 2; }

        /* --- Dark Mode --- */
        body.dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        body.dark .left-panel, body.dark .right-panel {
            background-color: rgba(45, 55, 72, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        body.dark input, body.dark select {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
            color: #e2e8f0;
        }
        body.dark .view-toggle { background-color: rgba(0,0,0,0.2); }
        body.dark .toggle-btn { color: #a0aec0; }
        body.dark .toggle-btn.active { background-color: rgba(74, 144, 226, 0.5); color: white; }
        body.dark #theme-toggle { background-color: #4A5568; color: #E2E8F0; }
        body.dark .person-item, body.dark .grid-cell { background-color: rgba(255, 255, 255, 0.05); }
        body.dark .grid-header { background-color: rgba(255, 255, 255, 0.1); }
        body.dark .schedule-day-item { background-color: rgba(45, 55, 72, 0.8); }
        body.dark #calendar-container, body.dark #historyScheduleDisplay { background-color: rgba(45, 55, 72, 0.5); }

        /* --- Light Mode --- */
        body.light {
            background-color: #f0f4f8;
            color: #1a202c;
        }
        body.light .left-panel, body.light .right-panel {
            background-color: rgba(255,255,255,0.7);
            border: 1px solid rgba(0,0,0,0.1);
        }
        body.light input, body.light select {
            background-color: #ffffff;
            border-color: #CBD5E0;
            color: #2D3748;
        }
        body.light .view-toggle { background-color: rgba(0,0,0,0.05); }
        body.light .toggle-btn { color: #4A5568; }
        body.light .toggle-btn.active { background-color: rgba(74, 144, 226, 0.8); color: white; }
        body.light #theme-toggle { background-color: #E2E8F0; color: #4A5568; }
        body.light .person-item, body.light .grid-cell { background-color: rgba(0,0,0,0.03); }
        body.light .grid-header { background-color: rgba(0,0,0,0.06); }
        body.light .schedule-day-item { background-color: rgba(255, 255, 255, 0.8); }
        body.light #calendar-container, body.light #historyScheduleDisplay { background-color: rgba(255, 255, 255, 0.8); }

        /* Other shared styles */
        .btn { background-color: rgba(74, 144, 226, 0.5); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: bold; transition: background-color 0.3s; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { background-color: rgba(74, 144, 226, 0.7); }
        .btn-red { background-color: rgba(255, 99, 71, 0.5); }
        .btn-red:hover { background-color: rgba(255, 99, 71, 0.7); }
        .schedule-day-item.highlight { border: 2px solid rgba(255, 215, 0, 0.8); box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .schedule-grid { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 0.5rem; width: 100%; }
        .grid-header, .grid-cell { padding: 0.75rem 1rem; text-align: center; }
        .schedule-cell { display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s, border 0.2s; border-radius: 0.5rem; }
        .schedule-cell.available { background-color: rgba(74, 182, 110, 0.4); border: 2px solid rgba(74, 182, 110, 0.8); }
        .schedule-cell.unavailable { background-color: rgba(239, 68, 68, 0.3); border: 2px solid rgba(239, 68, 68, 0.7); }
        #calendar-weekdays, #calendar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; }
        .calendar-day { display: flex; justify-content: center; align-items: center; height: 40px; border-radius: 50%; transition: background-color 0.2s; position: relative; }
        .calendar-day.has-schedule { background-color: rgba(74, 144, 226, 0.3); cursor: pointer; font-weight: bold; }
        .calendar-day.has-schedule:hover { background-color: rgba(74, 144, 226, 0.5); }
        .calendar-day.selected { background-color: rgba(74, 144, 226, 0.7); color: white; }
        .calendar-day.search-highlight { background-color: rgba(255, 215, 0, 0.2); border: 2px solid rgba(255, 215, 0, 0.8); box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.5); border-radius: 50%; }
        .person-item { display: flex; justify-content: space-between; align-items: center; }
        
        @media (max-width: 1024px) {
            .main-container { flex-direction: column; }
        }
        @media (max-width: 640px) {
            body { padding: 10px; }
            .left-panel, .right-panel { padding: 1.5rem; }
            .schedule-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .grid-header { display: none; }
        }
    </style>
</head>
<body class="dark">

    <div class="max-w-screen-xl mx-auto px-4">
        <header class="flex justify-between items-center py-6">
            <h1 class="text-4xl font-bold">排班系統</h1>
            <div class="flex items-center gap-4">
                 <button id="theme-toggle" class="p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white transition">
                    <svg id="theme-icon-dark" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" /></svg>
                    <svg id="theme-icon-light" class="h-6 w-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42M12 7a5 5 0 100 10 5 5 0 000-10z" /></svg>
                </button>
                <div class="view-toggle rounded-lg">
                    <button id="showSchedulerBtn" class="toggle-btn active px-4 py-2 text-sm rounded-lg">排班</button>
                    <button id="showHistoryBtn" class="toggle-btn px-4 py-2 text-sm rounded-lg">歷史紀錄</button>
                </div>
            </div>
        </header>

        <main class="main-container">
            <!-- Left Panel for Staff Management -->
            <div class="left-panel space-y-6">
                <h2 class="text-2xl font-bold">人員管理</h2>
                <div class="space-y-4">
                    <div class="flex items-center gap-2">
                        <input type="text" id="staffNameInput" class="flex-grow p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="輸入姓名">
                        <select id="staffCategorySelect" class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="member">成員</option>
                            <option value="cadre">幹部</option>
                        </select>
                        <button id="addStaffBtn" class="btn">新增</button>
                    </div>
                    <div>
                         <button id="exportDataBtn" class="btn text-sm">匯出成 Excel (CSV)</button>
                    </div>
                </div>
                <div id="staffList" class="space-y-2"></div>
            </div>

            <!-- Right Panel for Scheduling and History -->
            <div class="right-panel space-y-6">
                 <!-- Scheduler View -->
                <div id="schedulerView">
                    <div class="space-y-6">
                        <div>
                            <h2 class="text-2xl font-semibold mb-2">設定每日空閒狀態</h2>
                            <p class="text-sm text-gray-400 mb-4">點擊方格來切換人員當天是否有空。</p>
                            <div id="availabilityGrid" class="schedule-grid">
                                <!-- This will be populated by JavaScript -->
                            </div>
                        </div>
                        <div>
                            <label for="startDateInput" class="text-2xl font-semibold mb-2 block">排班開始日期</label>
                            <input type="date" id="startDateInput" class="w-full p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex justify-center">
                            <button id="generateBtn" class="btn btn-red px-8 py-3 text-lg">產生排班表</button>
                        </div>
                        <div id="scheduleResult" class="space-y-4 hidden">
                             <div class="flex justify-between items-center flex-wrap gap-4">
                                <h2 class="text-2xl font-semibold">排班表</h2>
                                <div class="search-group flex items-center">
                                    <input type="text" id="currentSearchInput" class="p-2 w-48 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="查詢姓名...">
                                    <button id="currentSearchBtn" class="btn ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg></button>
                                </div>
                            </div>
                            <div id="scheduleDisplay" class="space-y-4"></div>
                        </div>
                        <div id="errorMessage" class="text-red-400 text-center font-bold hidden"></div>
                    </div>
                </div>

                <!-- History View -->
                <div id="historyView" class="hidden space-y-6">
                     <div class="flex justify-between items-center flex-wrap gap-4">
                        <h2 class="text-2xl font-semibold">歷史紀錄</h2>
                        <div class="search-group flex items-center">
                            <input type="text" id="historySearchInput" class="p-2 w-48 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="查詢姓名...">
                            <button id="historySearchBtn" class="btn ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg></button>
                        </div>
                    </div>
                    <div id="calendar-container" class="p-4 rounded-lg">
                        <div id="calendar-header" class="flex justify-between items-center mb-4">
                            <button id="prevMonthBtn" class="btn p-2 w-10 h-10">&lt;</button>
                            <h3 id="monthYearDisplay" class="text-xl font-bold"></h3>
                            <button id="nextMonthBtn" class="btn p-2 w-10 h-10">&gt;</button>
                        </div>
                        <div id="calendar-weekdays" class="grid grid-cols-5 gap-2 mb-2 text-center font-bold"></div>
                        <div id="calendar-grid" class="grid grid-cols-5 gap-2"></div>
                    </div>
                    <div id="historyScheduleDisplay" class="mt-4 p-4 rounded-lg min-h-[100px]">
                        <p class="text-center">請點擊上方有紀錄的日期來查看排班表</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const staffNameInput = document.getElementById('staffNameInput');
            const staffCategorySelect = document.getElementById('staffCategorySelect');
            const addStaffBtn = document.getElementById('addStaffBtn');
            const staffListContainer = document.getElementById('staffList');
            const availabilityGridContainer = document.getElementById('availabilityGrid');
            const startDateInput = document.getElementById('startDateInput');
            const generateBtn = document.getElementById('generateBtn');
            const scheduleResultContainer = document.getElementById('scheduleResult');
            const scheduleDisplay = document.getElementById('scheduleDisplay');
            const errorMessage = document.getElementById('errorMessage');
            const showSchedulerBtn = document.getElementById('showSchedulerBtn');
            const showHistoryBtn = document.getElementById('showHistoryBtn');
            const schedulerView = document.getElementById('schedulerView');
            const historyView = document.getElementById('historyView');
            const exportDataBtn = document.getElementById('exportDataBtn');
            const currentSearchInput = document.getElementById('currentSearchInput');
            const currentSearchBtn = document.getElementById('currentSearchBtn');
            const historySearchInput = document.getElementById('historySearchInput');
            const historySearchBtn = document.getElementById('historySearchBtn');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            const monthYearDisplay = document.getElementById('monthYearDisplay');
            const calendarWeekdays = document.getElementById('calendar-weekdays');
            const calendarGrid = document.getElementById('calendar-grid');
            const historyScheduleDisplay = document.getElementById('historyScheduleDisplay');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconDark = document.getElementById('theme-icon-dark');
            const themeIconLight = document.getElementById('theme-icon-light');
            
            const weekdays = ['星期一', '星期二', '星期三', '星期四', '星期五'];
            
            let staffMembers = []; 
            let availability = {};
            let scheduleHistory = {};
            let calendarDate = new Date();
            let lastGeneratedStartDate = null;

            function applyTheme(theme) {
                if (theme === 'light') {
                    document.body.classList.remove('dark');
                    document.body.classList.add('light');
                    themeIconDark.classList.add('hidden');
                    themeIconLight.classList.remove('hidden');
                } else {
                    document.body.classList.remove('light');
                    document.body.classList.add('dark');
                    themeIconLight.classList.add('hidden');
                    themeIconDark.classList.remove('hidden');
                }
            }

            themeToggle.addEventListener('click', () => {
                const isDark = document.body.classList.contains('dark');
                const newTheme = isDark ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            function formatDate(date) {
                return date.toISOString().split('T')[0];
            }

            function loadData() {
                const storedTheme = localStorage.getItem('theme');
                applyTheme(storedTheme || 'dark');

                const storedStaff = localStorage.getItem('staffMembers');
                const storedAvailability = localStorage.getItem('availability');
                const storedHistory = localStorage.getItem('scheduleHistory');
                const storedLastStartDate = localStorage.getItem('lastGeneratedStartDate');

                if (storedStaff) staffMembers = JSON.parse(storedStaff);
                if (storedAvailability) availability = JSON.parse(storedAvailability);
                if (storedHistory) scheduleHistory = JSON.parse(storedHistory);
                if (storedLastStartDate) lastGeneratedStartDate = storedLastStartDate;

                if (lastGeneratedStartDate && scheduleHistory) {
                    try {
                        const lastSchedule = [];
                        const lastDates = [];
                        let currentDate = new Date(lastGeneratedStartDate + 'T00:00:00');

                        for (let i = 0; i < 5; i++) {
                            while (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                               currentDate.setDate(currentDate.getDate() + 1);
                            }
                            const dateKey = formatDate(currentDate);
                            if (scheduleHistory[dateKey]) {
                                lastSchedule.push(scheduleHistory[dateKey]);
                                lastDates.push(new Date(currentDate));
                            } else {
                                lastSchedule = [];
                                break;
                            }
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                        
                        if (lastSchedule.length === 5) {
                             displaySchedule(lastSchedule, lastDates);
                        }

                    } catch (e) {
                        console.error("Could not reconstruct last schedule view:", e);
                        localStorage.removeItem('lastGeneratedStartDate');
                    }
                }
                
                startDateInput.value = formatDate(new Date());
                renderAll();
            }

            function saveData() {
                localStorage.setItem('staffMembers', JSON.stringify(staffMembers));
                localStorage.setItem('availability', JSON.stringify(availability));
                localStorage.setItem('scheduleHistory', JSON.stringify(scheduleHistory));
                if (lastGeneratedStartDate) {
                    localStorage.setItem('lastGeneratedStartDate', lastGeneratedStartDate);
                } else {
                    localStorage.removeItem('lastGeneratedStartDate');
                }
            }

            function renderAll() {
                renderStaffList();
                renderAvailabilityGrid();
                renderCalendar();
            }

            function renderStaffList() {
                staffListContainer.innerHTML = '';
                if (staffMembers.length === 0) {
                    staffListContainer.innerHTML = '<p class="text-center">目前沒有人員。</p>';
                }
                staffMembers.forEach(person => {
                    const categoryText = person.category === 'cadre' ? '幹部' : '成員';
                    const personItem = document.createElement('div');
                    personItem.className = 'person-item p-2 rounded-md';
                    personItem.innerHTML = `
                        <span>${person.name} (${categoryText})</span>
                        <button class="btn-red p-2 rounded-md w-8 h-8 flex items-center justify-center text-sm" data-name="${person.name}">
                            &times;
                        </button>
                    `;
                    staffListContainer.appendChild(personItem);
                });
            }

            function renderAvailabilityGrid() {
                availabilityGridContainer.innerHTML = ''; // Clear the entire grid

                // Add headers
                const headers = ['姓名', '星期一', '星期二', '星期三', '星期四', '星期五'];
                headers.forEach(headerText => {
                    const headerEl = document.createElement('div');
                    headerEl.className = 'grid-header rounded-lg';
                    headerEl.textContent = headerText;
                    availabilityGridContainer.appendChild(headerEl);
                });

                // Add staff rows
                staffMembers.forEach(person => {
                    if (!availability[person.name]) {
                        availability[person.name] = new Array(5).fill(true);
                    }
                    
                    const nameCell = document.createElement('div');
                    nameCell.className = 'grid-cell text-left font-bold rounded-lg';
                    nameCell.textContent = person.name;
                    availabilityGridContainer.appendChild(nameCell);

                    for (let i = 0; i < 5; i++) {
                        const dayCell = document.createElement('div');
                        dayCell.className = `grid-cell schedule-cell ${availability[person.name][i] ? 'available' : 'unavailable'}`;
                        dayCell.dataset.day = i;
                        dayCell.dataset.person = person.name;
                        
                        const dayNameSpan = document.createElement('span');
                        dayNameSpan.className = 'sm:hidden';
                        dayNameSpan.textContent = weekdays[i];
                        dayCell.appendChild(dayNameSpan);
                        
                        availabilityGridContainer.appendChild(dayCell);
                    }
                });
            }
            
            function renderCalendar() {
                calendarGrid.innerHTML = '';
                calendarWeekdays.innerHTML = '';
                const year = calendarDate.getFullYear();
                const month = calendarDate.getMonth();
                monthYearDisplay.textContent = `${year}年 ${month + 1}月`;
                ['一', '二', '三', '四', '五'].forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.textContent = day;
                    calendarWeekdays.appendChild(dayEl);
                });
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                let paddingDays = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                for (let i = 0; i < paddingDays; i++) {
                    calendarGrid.appendChild(document.createElement('div'));
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month, day);
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        const dayEl = document.createElement('div');
                        dayEl.textContent = day;
                        dayEl.classList.add('calendar-day');
                        const dateStr = formatDate(currentDate);
                        if (scheduleHistory[dateStr]) {
                            dayEl.classList.add('has-schedule');
                            dayEl.dataset.date = dateStr;
                        }
                        calendarGrid.appendChild(dayEl);
                    }
                }
                if(historySearchInput.value.trim()){
                    highlightCalendarFromSearch();
                }
            }
            
            addStaffBtn.addEventListener('click', () => {
                const name = staffNameInput.value.trim();
                const category = staffCategorySelect.value;
                if (name && !staffMembers.some(p => p.name === name)) {
                    staffMembers.push({ name, category });
                    availability[name] = new Array(5).fill(true);
                    saveData();
                    renderAll();
                    staffNameInput.value = '';
                }
            });

            staffListContainer.addEventListener('click', (event) => {
                const target = event.target.closest('button');
                if (target) {
                    const name = target.dataset.name;
                    staffMembers = staffMembers.filter(p => p.name !== name);
                    delete availability[name];
                    saveData();
                    renderAll();
                }
            });

            availabilityGridContainer.addEventListener('click', (event) => {
                const target = event.target.closest('.schedule-cell');
                if (target) {
                    const person = target.dataset.person;
                    const day = parseInt(target.dataset.day, 10);
                    if (availability[person]) {
                        availability[person][day] = !availability[person][day];
                        target.classList.toggle('available');
                        target.classList.toggle('unavailable');
                        saveData();
                    }
                }
            });

            showSchedulerBtn.addEventListener('click', () => {
                schedulerView.classList.remove('hidden');
                historyView.classList.add('hidden');
                showSchedulerBtn.classList.add('active');
                showHistoryBtn.classList.remove('active');
            });

            showHistoryBtn.addEventListener('click', () => {
                schedulerView.classList.add('hidden');
                historyView.classList.remove('hidden');
                showSchedulerBtn.classList.remove('active');
                showHistoryBtn.classList.add('active');
                renderCalendar();
            });
            
            prevMonthBtn.addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            });
            
            nextMonthBtn.addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            });
            
            calendarGrid.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('has-schedule')) {
                    const dateStr = target.dataset.date;
                    const people = scheduleHistory[dateStr];
                    historyScheduleDisplay.innerHTML = `<h3 class="text-xl font-bold mb-2">${dateStr} 排班人員</h3><ul class="list-disc list-inside space-y-1">${people.map(p => `<li>${p}</li>`).join('')}</ul>`;
                    document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
                    target.classList.add('selected');
                }
            });

            exportDataBtn.addEventListener('click', () => {
                try {
                    if (Object.keys(scheduleHistory).length === 0) {
                        displayError('沒有歷史紀錄可匯出。');
                        return;
                    }
                    let csvContent = '\uFEFF';
                    csvContent += "日期,上班人員\r\n";
                    const sortedDates = Object.keys(scheduleHistory).sort();
                    sortedDates.forEach(date => {
                        const staff = scheduleHistory[date];
                        if (Array.isArray(staff) && staff.length > 0) {
                            const staffString = `"${staff.join('、 ')}"`;
                            csvContent += `${date},${staffString}\r\n`;
                        }
                    });
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `排班紀錄_${formatDate(new Date())}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    displayError('匯出資料時發生錯誤: ' + error.message);
                }
            });

            function performCurrentSearch() {
                const searchTerm = currentSearchInput.value.trim().toLowerCase();
                document.querySelectorAll('#scheduleDisplay .schedule-day-item').forEach(item => {
                    item.classList.remove('highlight');
                    if (searchTerm) {
                        const names = Array.from(item.querySelectorAll('li')).map(li => li.textContent.trim().toLowerCase());
                        if (names.some(name => name.includes(searchTerm))) {
                            item.classList.add('highlight');
                        }
                    }
                });
            }

            function highlightCalendarFromSearch() {
                const searchTerm = historySearchInput.value.trim().toLowerCase();
                document.querySelectorAll('.calendar-day').forEach(dayEl => dayEl.classList.remove('search-highlight'));
                if (!searchTerm) return [];
                const foundDates = Object.keys(scheduleHistory).filter(date => {
                    const people = scheduleHistory[date];
                    return Array.isArray(people) && people.some(name => typeof name === 'string' && name.toLowerCase().includes(searchTerm));
                });
                document.querySelectorAll('.calendar-day').forEach(dayEl => {
                    if (foundDates.includes(dayEl.dataset.date)) {
                        dayEl.classList.add('search-highlight');
                    }
                });
                return foundDates;
            }
            
            function performHistorySearch() {
                const searchTerm = historySearchInput.value.trim();
                const foundDates = highlightCalendarFromSearch();
                if (!searchTerm) {
                    historyScheduleDisplay.innerHTML = '<p class="text-center">請點擊上方有紀錄的日期來查看排班表</p>';
                    return;
                }
                if (foundDates.length > 0) {
                     historyScheduleDisplay.innerHTML = `<h3 class="text-xl font-bold mb-2">找到 ${searchTerm} 在以下 ${foundDates.length} 天有排班：</h3><ul class="list-disc list-inside space-y-1 max-h-40 overflow-y-auto">${foundDates.sort().map(d => `<li>${d}</li>`).join('')}</ul>`;
                } else {
                     historyScheduleDisplay.innerHTML = `<p class="text-center">在歷史紀錄中找不到 ${searchTerm} 的排班。</p>`;
                }
            }
            
            currentSearchBtn.addEventListener('click', performCurrentSearch);
            currentSearchInput.addEventListener('input', performCurrentSearch);
            historySearchBtn.addEventListener('click', performHistorySearch);
            historySearchInput.addEventListener('input', performHistorySearch);

            generateBtn.addEventListener('click', () => {
                if (staffMembers.length < 3) {
                    displayError('人員總數不足，無法排班 (需要至少3人)');
                    return;
                }
                if (!startDateInput.value) {
                    displayError('請選擇排班開始日期');
                    return;
                }
                
                scheduleResultContainer.classList.add('hidden');
                errorMessage.classList.add('hidden');
                scheduleDisplay.innerHTML = '';

                const maxRetries = 100;
                let scheduleFound = false;
                let generatedSchedule = [];

                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    const currentSchedule = new Array(5).fill(null).map(() => []);
                    const workCounts = staffMembers.reduce((acc, p) => ({ ...acc, [p.name]: 0 }), {});
                     
                    Object.values(scheduleHistory).flat().forEach(name => {
                        if (workCounts[name] !== undefined) {
                            workCounts[name]++;
                        }
                    });

                    let validAttempt = true;

                    for (let day = 0; day < 5; day++) {
                        const availableStaff = staffMembers.filter(p => availability[p.name] && availability[p.name][day]);
                        
                        if (availableStaff.length < 3) {
                            validAttempt = false;
                            break;
                        }
                        
                        const sortedAvailable = availableStaff
                            .sort(() => 0.5 - Math.random()) 
                            .sort((a, b) => workCounts[a.name] - workCounts[b.name]);

                        const dayPicks = sortedAvailable.slice(0, 3);
                        
                        dayPicks.forEach(person => {
                            currentSchedule[day].push(person.name);
                            workCounts[person.name]++;
                        });
                    }

                    if (!validAttempt) continue;
                    
                    generatedSchedule = currentSchedule;
                    scheduleFound = true;
                    break;
                }

                if (scheduleFound) {
                    const scheduleDates = [];
                    const baseDate = new Date(startDateInput.value + 'T00:00:00');
                    for(let i=0; i<5; i++){
                        let currentDate = new Date(baseDate);
                        currentDate.setDate(baseDate.getDate() + i);
                        while (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                           currentDate.setDate(currentDate.getDate() + 1);
                           baseDate.setDate(baseDate.getDate() + 1); 
                        }
                        scheduleDates.push(currentDate);
                    }
                    
                    lastGeneratedStartDate = formatDate(scheduleDates[0]);
                    generatedSchedule.forEach((people, index) => {
                        const dateStr = formatDate(scheduleDates[index]);
                        scheduleHistory[dateStr] = people;
                    });
                    
                    saveData();
                    displaySchedule(generatedSchedule, scheduleDates);
                    renderCalendar();
                } else {
                    displayError('無法找到符合所有條件的排班表，請調整人員空閒狀態或人數。');
                }
            });

            function displaySchedule(schedule, dates) {
                scheduleDisplay.innerHTML = '';
                schedule.forEach((people, index) => {
                    const dayItem = document.createElement('div');
                    dayItem.className = 'schedule-day-item rounded-lg p-4 space-y-2 transition-all duration-300';
                    const dateStr = dates[index].toLocaleDateString('zh-TW', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    dayItem.innerHTML = `<h3 class="text-xl font-bold">${dateStr}</h3><ul class="list-disc list-inside space-y-1">${people.map(p => `<li>${p}</li>`).join('')}</ul>`;
                    scheduleDisplay.appendChild(dayItem);
                });
                scheduleResultContainer.classList.remove('hidden');
            }

            function displayError(message) {
                errorMessage.innerHTML = `<div class="bg-red-500/20 border border-red-500 text-red-300 px-4 py-3 rounded-lg relative" role="alert">
                    <strong class="font-bold">發生錯誤！</strong>
                    <span class="block sm:inline">${message}</span>
                </div>`;
                errorMessage.classList.remove('hidden');
            }

            // --- Initial Load ---
            loadData();
        });
    </script>
</body>
</html>


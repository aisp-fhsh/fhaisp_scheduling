<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排班系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }

        .glass-container {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2.5rem;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Adjusted gap */
            margin: 2rem auto; /* Centering the container */
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .view-toggle {
            display: flex;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 9999px;
            padding: 0.25rem;
        }

        .toggle-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background-color: transparent;
            color: #a0aec0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .toggle-btn.active {
            background-color: rgba(74, 144, 226, 0.5);
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .input-group, .schedule-availability, .search-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(6, minmax(0, 1fr));
            gap: 0.5rem;
            width: 100%;
        }

        .grid-header, .grid-cell {
            padding: 0.75rem;
            text-align: center;
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
        }
        
        .grid-header {
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .schedule-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .schedule-cell.available {
            background-color: rgba(139, 232, 139, 0.3);
        }

        .schedule-cell.unavailable {
            background-color: rgba(255, 99, 71, 0.3);
        }

        .person-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .btn {
            background-color: rgba(74, 144, 226, 0.5);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            background-color: rgba(74, 144, 226, 0.7);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
        }

        .btn-red {
            background-color: rgba(255, 99, 71, 0.5);
        }

        .btn-red:hover {
            background-color: rgba(255, 99, 71, 0.7);
        }
        
        .schedule-day-item.highlight {
            border: 2px solid rgba(255, 215, 0, 0.8);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }


        /* Calendar Styles */
        #calendar-weekdays,
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }
        .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            border-radius: 50%;
            transition: background-color 0.2s;
            position: relative;
        }
        .calendar-day.has-schedule {
            background-color: rgba(74, 144, 226, 0.3);
            cursor: pointer;
            font-weight: bold;
        }
         .calendar-day.has-schedule:hover {
            background-color: rgba(74, 144, 226, 0.5);
        }
        .calendar-day.selected {
            background-color: rgba(74, 144, 226, 0.7);
            color: white;
        }
        .calendar-day.search-highlight {
            background-color: rgba(255, 215, 0, 0.2); /* More transparent background */
            border: 2px solid rgba(255, 215, 0, 0.8); /* Stronger border */
            /* Enhanced shadow for a better "glow" effect */
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.5);
            border-radius: 50%;
        }


        @media (max-width: 640px) {
            body {
                padding: 10px;
            }
            .glass-container {
                padding: 1.5rem;
                margin: 1rem auto;
            }
            .header-container {
                flex-direction: column;
                gap: 1rem;
            }
            .schedule-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .grid-header {
                display: none;
            }
            .schedule-availability .grid-header {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="glass-container">
        <div class="header-container">
            <h1 class="text-4xl font-bold text-center">排班系統</h1>
            <div class="view-toggle">
                <button id="showSchedulerBtn" class="toggle-btn active">排班</button>
                <button id="showHistoryBtn" class="toggle-btn">歷史紀錄</button>
            </div>
        </div>
        <p class="text-center text-xs text-gray-400">資料狀態: <span id="syncStatus">正在連線...</span></p>

        <!-- 排班主畫面 -->
        <div id="schedulerView">
            <!-- 人員名單管理 -->
            <div class="space-y-4">
                <h2 class="text-2xl font-semibold">人員管理</h2>
                <div class="input-group">
                    <input type="text" id="staffNameInput" class="flex-grow p-3 rounded-lg bg-gray-700 bg-opacity-50 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="輸入工作人員姓名">
                    <select id="staffCategorySelect" class="p-3 rounded-lg bg-gray-700 bg-opacity-50 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="member">成員</option>
                        <option value="cadre">幹部</option>
                    </select>
                    <button id="addStaffBtn" class="btn">新增人員</button>
                </div>
                <div id="staffList" class="space-y-2"></div>
            </div>

            <!-- 空閒狀態設定 -->
            <div class="space-y-4">
                <h2 class="text-2xl font-semibold">設定每日空閒狀態</h2>
                <p class="text-sm text-gray-400">點擊方格來切換人員當天是否有空。</p>
                <div class="schedule-availability">
                    <div class="schedule-grid">
                        <div class="grid-header">姓名</div>
                        <div class="grid-header">星期一</div>
                        <div class="grid-header">星期二</div>
                        <div class="grid-header">星期三</div>
                        <div class="grid-header">星期四</div>
                        <div class="grid-header">星期五</div>
                        <div id="availabilityGrid" class="contents"></div>
                    </div>
                </div>
            </div>
            
            <!-- 開始日期 -->
            <div class="space-y-2">
                <label for="startDateInput" class="text-lg font-semibold">排班開始日期</label>
                <input type="date" id="startDateInput" class="w-full p-3 rounded-lg bg-gray-700 bg-opacity-50 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- 產生排班表 -->
            <div class="flex justify-center mt-4">
                <button id="generateBtn" class="btn btn-red">產生排班表</button>
            </div>

            <!-- 排班表顯示區 -->
            <div id="scheduleResult" class="space-y-4 hidden">
                 <div class="flex justify-between items-center flex-wrap gap-4">
                    <h2 class="text-2xl font-semibold">排班表</h2>
                    <div class="search-group">
                        <input type="text" id="currentSearchInput" class="p-2 w-48 rounded-lg bg-gray-700 bg-opacity-50 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="查詢姓名...">
                        <button id="currentSearchBtn" class="btn btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                              <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="scheduleDisplay" class="space-y-4"></div>
            </div>

            <!-- 錯誤訊息 -->
            <div id="errorMessage" class="text-red-400 text-center font-bold hidden"></div>
        </div>

        <!-- 歷史紀錄畫面 -->
        <div id="historyView" class="hidden">
            <div class="search-group mb-4">
                <input type="text" id="historySearchInput" class="flex-grow p-3 rounded-lg bg-gray-700 bg-opacity-50 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="輸入姓名查詢歷史紀錄">
                <button id="historySearchBtn" class="btn btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                      <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                    <span class="ml-2">查詢</span>
                </button>
            </div>
            <div id="calendar-container" class="bg-gray-800 bg-opacity-50 p-6 rounded-lg">
                <div id="calendar-header" class="flex justify-between items-center mb-4">
                    <button id="prevMonthBtn" class="btn p-2 w-10 h-10">&lt;</button>
                    <h3 id="monthYearDisplay" class="text-xl font-bold"></h3>
                    <button id="nextMonthBtn" class="btn p-2 w-10 h-10">&gt;</button>
                </div>
                <div id="calendar-weekdays" class="grid grid-cols-5 gap-2 mb-2 text-center text-gray-400 font-bold"></div>
                <div id="calendar-grid" class="grid grid-cols-5 gap-2"></div>
            </div>
            <div id="historyScheduleDisplay" class="mt-4 p-4 bg-gray-800 bg-opacity-50 rounded-lg min-h-[100px]">
                <p class="text-center text-gray-400">請點擊上方有紀錄的日期來查看排班表</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // V IMPORTANT INSTRUCTION V
        // Please paste your Firebase config object here.
        // You can get this from the Firebase console:
        // Project settings > General > Your apps > Web app > SDK setup and configuration > Config
        const MANUAL_FIREBASE_CONFIG = {
            // apiKey: "...",
            // authDomain: "...",
            // projectId: "...",
            // storageBucket: "...",
            // messagingSenderId: "...",
            // appId: "..."
        };
        // ^ IMPORTANT INSTRUCTION ^


        document.addEventListener('DOMContentLoaded', async () => {
            // DOM Elements
            const staffNameInput = document.getElementById('staffNameInput');
            const staffCategorySelect = document.getElementById('staffCategorySelect');
            const addStaffBtn = document.getElementById('addStaffBtn');
            const staffListContainer = document.getElementById('staffList');
            const availabilityGridContainer = document.getElementById('availabilityGrid');
            const startDateInput = document.getElementById('startDateInput');
            const generateBtn = document.getElementById('generateBtn');
            const scheduleResultContainer = document.getElementById('scheduleResult');
            const scheduleDisplay = document.getElementById('scheduleDisplay');
            const errorMessage = document.getElementById('errorMessage');
            const showSchedulerBtn = document.getElementById('showSchedulerBtn');
            const showHistoryBtn = document.getElementById('showHistoryBtn');
            const schedulerView = document.getElementById('schedulerView');
            const historyView = document.getElementById('historyView');
            const syncStatus = document.getElementById('syncStatus');
            
            const currentSearchInput = document.getElementById('currentSearchInput');
            const currentSearchBtn = document.getElementById('currentSearchBtn');
            const historySearchInput = document.getElementById('historySearchInput');
            const historySearchBtn = document.getElementById('historySearchBtn');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            const monthYearDisplay = document.getElementById('monthYearDisplay');
            const calendarWeekdays = document.getElementById('calendar-weekdays');
            const calendarGrid = document.getElementById('calendar-grid');
            const historyScheduleDisplay = document.getElementById('historyScheduleDisplay');
            
            const weekdays = ['星期一', '星期二', '星期三', '星期四', '星期五'];
            
            // --- Local State ---
            let staffMembers = []; 
            let availability = {};
            let scheduleHistory = {};
            let calendarDate = new Date();
            let unsubscribe; // To stop listening to changes when needed

            // --- Firebase Setup ---
            let db, auth, docRef;

            async function initFirebase() {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-public-scheduler';
                    
                    // Use manual config if available, otherwise try the injected one
                    const firebaseConfig = MANUAL_FIREBASE_CONFIG.apiKey ? MANUAL_FIREBASE_CONFIG : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
                    
                    if (!firebaseConfig || !firebaseConfig.apiKey) {
                        syncStatus.textContent = "錯誤：缺少 Firebase 設定";
                        syncStatus.style.color = "#ef4444"; // Red
                        console.error("Firebase config is missing or invalid. Please paste it into the MANUAL_FIREBASE_CONFIG object in the script.");
                        return;
                    }

                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // Correct, even-segmented path (6 segments)
                    docRef = doc(db, 'artifacts', appId, 'public/data', 'scheduler', 'sharedState');

                    await signIn();
                    
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                             if(unsubscribe) unsubscribe(); // Unsubscribe from previous listener if any
                             unsubscribe = onSnapshot(docRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    staffMembers = data.staffMembers || [];
                                    availability = data.availability || {};
                                    scheduleHistory = data.scheduleHistory || {};
                                } else {
                                    // If doc doesn't exist, initialize with empty data
                                    staffMembers = [];
                                    availability = {};
                                    scheduleHistory = {};
                                }
                                renderAll();
                                syncStatus.textContent = "已同步";
                                syncStatus.style.color = "#22c55e"; // Green
                            }, (error) => {
                                console.error("Error listening to document: ", error);
                                syncStatus.textContent = "監聽錯誤";
                                syncStatus.style.color = "#ef4444";
                            });
                        } else {
                            if (unsubscribe) unsubscribe();
                            syncStatus.textContent = "未驗證";
                            syncStatus.style.color = "#eab308"; // Yellow
                        }
                    });

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    syncStatus.textContent = "Firebase 初始化失敗";
                    syncStatus.style.color = "#ef4444";
                }
            }

            async function signIn() {
                try {
                    // Prioritize injected token if available
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error)

